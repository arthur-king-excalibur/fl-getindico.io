{% extends 'forms/base_widget.html' %}

{% block html %}
    <div class="form-row typeahead-container" data-tooltip-anchor>
        <div class="typeahead-field">
            <input id="{{ field.id }}" autocomplete="off" class="typeahead" type="text"
                   {% if not search_url %}name="{{ field.name }}"{% endif %}
                   {%- if field.data is not none -%}value="{{ field._value() }}"{%- endif -%}>
        </div>
    </div>
{% endblock %}

{% block javascript %}
    <script>
        (function() {
            'use strict';

            var field = $('#{{ field.id }}');
            var params = {
                hint: true,
                display: 'name',
                mustSelectItem: true,
                minLength: {{ min_trigger_length }},
                source: {
                    data: {{ choices | tojson }}
                }
            };

            {% if search_url %}
                // TODO: we should have a separate option to determine if ONLY searched results are allowed
                $.extend(true, params, {
                    dynamic: true,
                    source: {
                        url: [{
                            url: {{ search_url | tojson }},
                            data: {
                                q: {% raw %}'{{query}}'{% endraw %}
                            }
                        }]
                    },
                    callback: {
                        onClickAfter: function(node, a, item) {
                            if (!item) {
                                return;
                            }

                            var dataField = $('#{{ field.id }}-data');
                            if (!dataField.length) {
                                dataField = $('<input>', {
                                    type: 'hidden',
                                    id: '{{ field.id }}-data',
                                    name: {{ field.name | tojson }}
                                });
                                dataField.insertAfter(field);
                            }
                            dataField.val(item['id']).triggerHandler('change');
                            field.trigger('typeaheadSelected', [item]);
                        }
                    }
                });
            {% endif %}

            field.typeahead($.extend(true, params, {{ options | tojson }}));
        })();
    </script>
{% endblock %}
