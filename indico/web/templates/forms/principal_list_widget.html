{% extends 'forms/base_widget.html' %}


{% block html %}
    {% set value_json = field._value() | tojson %}
    <div class="i-form-field-fixed-width" data-tooltip-anchor>
        {% if acl and field.inherited_acl_count %}
            <div class="action-box for-form highlight inheriting-acl-message" style="display: block;">
                <div class="section">
                    <div class="text">
                        <div>
                            {% trans %}Since the protection mode is set to <em>inheriting</em>, users from the <strong>inherited access control list</strong> will also have access.{% endtrans %}
                        </div>
                    </div>
                    <div class="toolbar right">
                        <a href="#" class="i-button highlight"
                           data-href="{{ field.acl_url }}"
                           data-title="{% trans %}Inherited access list{% endtrans %}"
                           data-subtitle="{{ field.protected_object.title }}"
                           data-close-button
                           data-ajax-dialog>
                            {% trans %}View list{% endtrans %}
                        </a>
                    </div>
                </div>
            </div>
        {% endif %}
        <div id="userGroupList-{{ field.id }}" style="margin-bottom: 10px;"></div>
        <input type="hidden" id="{{ field.id }}" name="{{ field.name }}" value="{{ value_json | forceescape }}"
               {{ input_args | html_params }}>
        <span></span>
    </div>
{% endblock %}


{% block javascript %}
    <script>
        (function() {
            'use strict';

            var field = $('#{{ field.id }}');
            var principals = JSON.parse(field.val());

            function addPrincipal(newPrincipals, setResult) {
                // remove existing ones first to avoid duplicates
                _.each(newPrincipals, function(principal) {
                    principals = _.without(principals, _.findWhere(principals, {
                        identifier: principal.identifier
                    }));
                });
                principals = principals.concat(newPrincipals);
                field.val(JSON.stringify(principals));
                field.trigger('change');
                setResult(true, principals);
            }
            function removePrincipal(principal, setResult) {
                principals = _.without(principals, _.findWhere(principals, {
                    identifier: principal.get('identifier')
                }));
                field.val(JSON.stringify(principals));
                field.trigger('change');
                setResult(true);
            }
            var widget = new UserListField(
                'PluginOptionPeopleListDiv', 'user-list', principals,
                true, null, true,
                {{ field.groups | tojson }},
                {{ field.event.id if field.event else none|tojson }},
                null, false, false, false,
                // Disable favorite button for EventPerson mode
                {{ (field.event is none)|tojson }},
                addPrincipal, userListNothing, removePrincipal, {{ field.allow_external|tojson }}
            );

            $('#{{ field.id }}').parent().find('.inheriting-acl-message').on('protection:inheriting', function(evt, isInheriting) {
                $(this).toggle(isInheriting);
            });

            $E('userGroupList-{{ field.id }}').set(widget.draw());
        })();
    </script>
{% endblock %}
