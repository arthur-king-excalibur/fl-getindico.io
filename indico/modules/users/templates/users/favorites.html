{% extends 'users/base.html' %}
{% from 'users/_favorites.html' import favorite_users_list %}

{% block subtitle -%}
    {% trans %}Favourites{% endtrans %}
{%- endblock %}

{% block user_content %}
    <div class="layout-wrapper">
        <div class="row">
            <div class="column col-50">
                <div class="i-box titled">
                    <div class="i-box-header">
                        <div class="i-box-title">
                            {%- trans %}Favorite Users{% endtrans -%}
                        </div>
                    </div>
                    <div class="i-box-content">
                        <ul class="group-list no-description favorite-users">
                            {{ favorite_users_list(user) }}
                        </ul>
                    </div>
                </div>
                <button class="i-button highlight add-user" style="margin-top: 15px;">{% trans %}Add Indico user{% endtrans %}</button>
            </div>
            <div class="column col-50">
                <div class="i-box titled">
                    <div class="i-box-header">
                        <div class="i-box-title">
                            {%- trans %}Favorite Categories{% endtrans -%}
                        </div>
                    </div>
                    <div class="i-box-content">
                        <ul class="group-list no-description">
                            {% for category in user.favorite_categories|sort(attribute='name') %}
                                <li data-categ-id="{{ category.id }}" class="favorite-categ js-category-row">
                                    <span>{{ category.name }}</span>
                                    <a class="toggle icon-remove right js-delete-category" href="#"
                                       data-href="{{ url_for('.user_favorites_category_remove', category_id=category.id) }}"></a>
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        var initFavoriteUserRemoval = function(){
            $('.js-delete-user').on('click', function(e){
                e.preventDefault();
                var $this = $(this);
                $.ajax({
                    url: $this.data('href'),
                    method: 'DELETE',
                    error: handleAjaxError,
                    success: function(data) {
                        $this.closest('.js-user-row').fadeOut(function() {
                            $(this).remove();
                        });
                    }
                });
            });
        };


        var addFavoriteUsers = function(list, setResult){
            $.ajax({
                url: "{{ url_for('.user_favorites_users_add') }}",
                method: 'POST',
                dataType: 'json',
                data: {
                    user_id: _.pluck(list, 'id')
                },
                traditional: true,
                error: handleAjaxError,
                success: function(data) {
                    $('.favorite-users').html(data.html);
                    initFavoriteUserRemoval();
                }
            });
        };

        $('.add-user').on('click', function(){
            var chooseUsersPopup = new ChooseUsersPopup($T('Search Users'), true, null, false, false, null, false, false, false, addFavoriteUsers);
            chooseUsersPopup.execute();
        });

        initFavoriteUserRemoval();

        $('.js-delete-category').on('click', function(e){
            e.preventDefault();
            var $this = $(this);
            $.ajax({
                url: $this.data('href'),
                method: 'DELETE',
                error: handleAjaxError,
                success: function(data) {
                    $this.closest('.js-category-row').fadeOut(function() {
                        $(this).remove();
                    });
                }
            });
        });
    </script>
{% endblock %}
