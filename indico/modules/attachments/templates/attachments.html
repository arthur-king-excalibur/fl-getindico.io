{% extends 'layout/base.html' %}
{% from 'attachments/_attachments.html' import render_attachments %}

{% block title %}{% trans %}Attachments{% endtrans %}{% endblock %}

{% block content %}
    <div class="action-box fixed-width">
        <div class="section">
            <span class="icon icon-upload"></span>
            <div class="text">
                <div class="label">{% trans %}Add attachments to the event.{% endtrans %}</div>
                <div>{% trans %}You can attach files or links using the buttons on the right.{% endtrans %}</div>
            </div>
            <div class="toolbar right">
                <div class="group">
                    <a href="#" class="i-button icon-file js-dialog-action"
                       data-href="{{ url_for('.upload', linked_object) }}"
                       data-title="{%- trans %}Upload files{% endtrans -%}">
                        {%- trans %}Upload files{% endtrans -%}
                    </a>
                    <a href="#" class="i-button icon-link js-dialog-action"
                       data-href="{{ url_for('.add_link', linked_object) }}"
                       data-title="{%- trans %}Add link{% endtrans -%}">
                        {%- trans %}Add link{% endtrans -%}
                    </a>
                </div>
            </div>
        </div>
    </div>
    <div class="i-box fixed-width" id="attachments-container">
        {{ render_attachments(attachments, linked_object) }}
    </div>
    <script>
        $(document)
            .on('click', 'ul.tree > li.expandable .actions > a', function(evt) {
                evt.stopPropagation();
            })
            .on('click', 'ul.tree > li.expandable', function() {
                $(this)
                    .toggleClass('collapsed')
                    .children('ul.sub-tree')
                        .slideToggle(150);
            })
            .on('click', 'ul.tree > li.expandable > .sub-tree', function(evt) {
                evt.stopPropagation();
            })
            .on('click', '.js-dialog-action', function() {
                var $this = $(this);
                ajaxDialog({
                    url: $this.data('href'),
                    title: $this.data('title'),
                    onClose: function(data) {
                        if (data) {
                            $('#attachments-container').html(data.attachment_list);
                        }
                    }
                });
            })
            .on('indico:confirmed', '.js-delete', function(evt) {
                evt.preventDefault();

                var $this = $(this);
                $.ajax({
                    url: $this.data('href'),
                    method: $this.data('method'),
                    complete: IndicoUI.Dialogs.Util.progress(),
                    error: handleAjaxError,
                    success: function(data) {
                        $('#attachments-container').html(data.attachment_list);
                        handleFlashes(data);
                    }
                });
            })
    </script>
{% endblock %}
