{% from 'message_box.html' import message_box %}
{% from 'events/sessions/management/_types_table.html' import types_table_row %}

<div class="manage-session-types">
    <div class="toolbar space-after hide-if-locked">
        <button class="i-button js-new-session-type icon-plus highlight"
                data-href="{{ url_for('.create_type', event) }}"
                data-title="{% trans %}Add new session type{% endtrans %}"
                data-ajax-dialog>
            {% trans %}New session type{% endtrans %}
        </button>
    </div>

    {% if types %}
        <table class="i-table">
            <thead>
                <tr class="i-table">
                    <th class="i-table name-column">
                        {% trans %}Name{% endtrans %}
                    </th>
                    <th class="i-table">
                        {% trans %}Poster{% endtrans %}
                    </th>
                    <th class="i-table action-column hide-if-locked"></th>
                </tr>
            </thead>
            <tbody>
                {% for session_type in types %}
                    {{ types_table_row(session_type) }}
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        {%- call message_box('info') %}
            {%- trans %}There are no session types yet.{% endtrans %}
        {%- endcall %}
    {% endif %}

    <div class="toolbar f-j-end">
        <button class="i-button big" data-button-back>{% trans %}Close{% endtrans %}</button>
    </div>
</div>

<script>
    (function() {
        'use strict';
        var $manageSessionTypes = $('.manage-session-types');
        /* Set the customData to true indicating that the session list needs to be refreshed */
        function dialogModified() {
            $manageSessionTypes.trigger('ajaxDialog:setData', [true]);
        }

        $('.manage-session-types table').tablesorter({
            sortList: [[0, 0]],
            headers: {
                2: {
                    sorter: false
                }
            }
        });

        $('.js-new-session-type').on('ajaxDialog:closed', function(evt, data) {
            evt.preventDefault();
            if (data) {
                var $lastRow = $('.manage-session-types table tr:last');
                if ($lastRow.length) {
                    $lastRow.after(data.html_row);
                } else {
                    $manageSessionTypes.trigger('ajaxDialog:reload');
                }
            }
        });



        $manageSessionTypes.on('ajaxDialog:closed', '.js-edit-session-type', function(evt, data) {
            evt.preventDefault();
            var $row = $(this).closest('tr');
            if (data) {
                $row.replaceWith(data.html_row);
                dialogModified();
            }
        });

        $manageSessionTypes.on('indico:confirmed', '.js-delete-session-type', function(evt) {
            evt.preventDefault();
            var $this = $(this);
            var $row = $this.closest('tr');
            $.ajax({
                url: $this.data('href'),
                method: $this.data('method'),
                complete: IndicoUI.Dialogs.Util.progress(),
                error: handleAjaxError,
                success: function() {
                    $row.remove();
                    dialogModified();
                    if ($('.manage-session-types table tbody tr').length === 0) {
                        $manageSessionTypes.trigger('ajaxDialog:reload');
                    }
                }
            });
        });
    })();
</script>
