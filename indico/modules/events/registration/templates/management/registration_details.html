{% extends 'events/registration/management/_regform_base.html' %}
{% from 'events/registration/display/_registration_summary_blocks.html' import render_registration_summary,
                                                                               render_invoice %}

{% block subtitle %}
    Details for #{{registration.friendly_id}}:
    {{ registration.full_name }} in "{{ registration.registration_form.title }}"
{% endblock %}

{% block content %}
    <div class="action-box">
       <div class="section">
           <div class="icon icon-quill"></div>
            {% if registration.state.name == 'pending' %}
                {{ render_pending_actions() }}
            {% elif registration.state.name == 'unpaid' %}
                {{ render_unpaid_actions() }}
            {% elif registration.state.name == 'complete' %}
                {{ render_complete_actions() }}
            {% elif registration.state.name in ('rejected', 'withdrawn') %}
                {{ render_cancalled_actions() }}
            {% endif %}
        </div>
        {% if registration.state.name in ('unpaid', 'complete') %}
            {{ render_check_in() }}
        {% endif %}
    </div>

    {{ render_registration_summary(registration, from_management) }}
    {% call render_invoice(registration, payment_enabled, currency) %}
        <table class="regform-done-footer registration-info">
            <tr>
                <td>
                    {% if registration.transaction and registration.transaction.data.changed_by_name %}
                        <div class="checkbox-with-text">
                            <div class="payment-conditions-agreement">
                                {%- trans updated_by=registration.transaction.data.changed_by_name,
                                         timestamp=registration.transaction.timestamp | format_date -%}
                                    Last updated by {{ updated_by }} on {{ timestamp }}.
                                {% endtrans -%}
                            </div>
                        </div>
                    {% endif %}
                </td>
                <td class="regform-done-footer-button">
                    {% if not registration.is_paid %}
                        <a class="i-button big"
                           data-update=".management-page"
                           data-method="POST"
                           data-params="{{ dict(pay=1) | tojson | forceescape }}"
                           data-href="{{ url_for('.toggle_registration_payment', registration) }}">
                            {% trans %}Mark as paid{% endtrans %}
                        </a>
                    {% else %}
                        <a class="i-button big"
                           data-update=".management-page"
                           data-method="POST"
                           data-params="{{ dict(pay=0) | tojson | forceescape }}"
                           data-href="{{ url_for('.toggle_registration_payment', registration) }}">
                            {% trans %}Mark as unpaid{% endtrans %}
                        </a>
                    {% endif %}
                </td>
            </tr>
        </table>
    {% endcall %}

    {% if registration.transaction %}
        <div id="registration-summary" class="regform-done">
            <div class="i-box-header">
                <div class="i-box-title">
                    {% trans %}Payment transaction{% endtrans %}
                </div>
            </div>
            <div class="i-box-content">
                {{ registration.transaction.render_details()|safe }}
            </div>
        </div>
    {% endif %}

    <div class="permalink-text">
        <div>
            {% trans -%}
                Give this link to the user to manage their registration.<br>
                Make sure to keep it private as anybody with this link will be able to manage it.
            {%- endtrans %}
        </div>
        <input type="text" class="permalink" readonly
               value="{{ url_for('.display_regform', registration.locator.uuid, _external=true) }}">
    </div>

    <div class="right">
        <button data-href="{{ url_for('.edit_registration', registration) }}" data-method="GET"
           class="i-button big highlight" {% if registration.is_cancelled %} disabled="disbled"{% endif %}>
            {%- trans %}Modify{% endtrans -%}
        </button>
        <a href="{{ url_for('.manage_reglist', registration.registration_form) }}" class="i-button big">
            {%- trans %}Back{% endtrans -%}
        </a>
    </div>
{% endblock %}


{% macro render_pending_actions() %}
    <div class="text">
       <div class="label">
           {% trans %}Registration awaiting manager approval{% endtrans %}
       </div>
       {% trans -%}
           You can validate or reject it and the user will receive a notification.
       {%- endtrans %}
    </div>
    <div class="toolbar right">
        <div class="group">
            <a class="i-button accept"
               data-update=".management-page"
               data-method="POST"
               data-href="{{ url_for('.approve_registration', registration) }}">
                {%- trans %}Approve{% endtrans -%}
            </a>
        </div>
        <div class="group">
            <a class="i-button danger"
               data-update=".management-page"
               data-method="POST"
               data-href="{{ url_for('.reject_registration', registration) }}"
               data-confirm="{% trans %}Are you sure you want to reject this registration? This action is not reversible.{% endtrans %}"
               data-title="{% trans %}Reject registration{% endtrans %}">
                {%- trans %}Reject{% endtrans -%}
            </a>
        </div>
    </div>
{% endmacro %}


{% macro render_unpaid_actions() %}
    <div class="text">
        <div class="label">
           {% trans %}Registration not paid yet{% endtrans %}
        </div>
        {% trans -%}
            You can mark it as paid manually.
        {%- endtrans %}
    </div>
    <div class="toolbar right">
        <div class="group">
            <span class="i-button label icon-coins">
                {{ registration.render_price() }}
            </span>
        </div>
        <div class="group">
            <a class="i-button js-modify-payment"
               data-update=".management-page"
               data-method="POST"
               data-params="{{ dict(pay=1) | tojson | forceescape }}"
               data-href="{{ url_for('.toggle_registration_payment', registration) }}">
                {% trans %}Mark as paid{% endtrans %}
            </a>
        </div>
    </div>
{% endmacro %}


{% macro render_complete_actions() %}
    <div class="text">
        <div class="label">
            {% trans %}This registration is complete{% endtrans %}
        </div>
        {% trans submitted=registration.submitted_dt|format_date %}
            Submited: {{ submitted }}
        {% endtrans %}
    </div>
    {% if registration.registration_form.tickets_enabled %}
        <div class="toolbar right">
            <a href="{{ url_for('.ticket_download', registration.locator.registrant) }}" class="i-button accept icon-ticket">
                {% trans %}Get ticket{% endtrans %}
            </a>
        </div>
    {% endif %}
{% endmacro %}


{% macro render_cancalled_actions() %}
    <div class="text">
        <div class="label">
            {% trans state=registration.state.title|lower%}
                This registration is {{ state }}
            {% endtrans %}
        </div>
    </div>
{% endmacro %}


{% macro render_check_in() %}
    <div class="section">
        <div class="icon icon-location"></div>
        {% if registration.checked_in %}
            <div class="text">
                <div class="label">
                    {% trans %}Checked in{% endtrans %}
                </div>
                {% trans checked_in_dt=registration.checked_in_dt|format_date -%}
                    Checked in: {{ checked_in_dt }}
                {%- endtrans %}
                (<a href="#"
                   title="{% trans %}Mark as not checked in{% endtrans %}"
                   data-update=".management-page"
                   data-method="POST"
                   data-href="{{ url_for('.toggle_registration_checked_in', registration) }}"
                   data-confirm="{% trans %}Are you sure you want to reset the check-in info? The original check-in time will be lost.{% endtrans %}"
                   data-title="{% trans %}Reset check-in info{% endtrans %}">
                   {%- trans %}reset{% endtrans -%}
                </a>)
            </div>
        {% else %}
            <div class="text">
                <div class="label">
                    {% trans %}Not checked in{% endtrans %}
                </div>
                {% if registration.registration_form.tickets_enabled %}
                    {% trans -%}
                        You can mark it as checked in manually here or with the Indico Check in app.
                    {%- endtrans %}
                {% else %}
                    {% trans -%}
                        You can mark it as checked in manually.
                    {%- endtrans %}
                {% endif %}
            </div>
            <div class="toolbar right">
                <a class="i-button"
                   data-update=".management-page"
                   data-method="POST"
                   data-href="{{ url_for('.toggle_registration_checked_in', registration) }}">
                    {% trans %}Check-in{% endtrans %}
                </a>
            </div>
        {% endif %}
    </div>
{% endmacro %}
